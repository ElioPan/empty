<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ev.report.dao.OutsourcedManagementAccountingReportDao">

    <select id="outsourcedContractList" resultType="java.util.Map">
        SELECT
        item.`id`,
        outsourcing.`id` AS outsourcingContractId,
        outsourcing.`contract_code` AS `contractCode`,
        outsourcing.contract_date AS contractDate,
        supplier.`id` AS `supplierId`,
        supplier.`name` AS supplierName,
        outsourcingUser.`user_id` AS `userId`,
        outsourcingUser.`name` AS userName,
        outsourcingUserDept.dept_id AS `deptId`,
        outsourcingUserDept.name AS deptName,
        materielType.name AS materielTypeName,
        materiel.serial_no AS materielSerialNo,
        materiel.name AS materielName,
        materiel.specification AS specification,
        unitUom.name AS unitUomName,
        item.`count` AS `count`,
        item.`tax_unit_price` AS taxUnitPrice,
        item.`tax_amount` AS taxAmount
        FROM
        scm_outsourcingcontract_item item
        LEFT JOIN scm_outsourcingcontract outsourcing ON outsourcing.id = item.outsourcingcontract_id
        LEFT JOIN cus_supplier supplier ON supplier.id = outsourcing.supplier_id
        LEFT JOIN sys_user outsourcingUser ON outsourcingUser.user_id = outsourcing.outsourcing_person
        LEFT JOIN sys_dept outsourcingUserDept ON outsourcingUserDept.dept_id = outsourcing.outsourcing_person_dept
        LEFT JOIN cus_materiel materiel ON materiel.`id`=item.`materiel_id`
        LEFT JOIN cus_materiel_type materielType ON materielType.`id`=materiel.`type`
        LEFT JOIN cus_dictionary unitUom ON unitUom.id = materiel.`unit_uom`
        <where>
            <if test="id != null and id != ''"> and item.id = #{id} </if>
            <if test="startTime != null and startTime != ''"> and  DATE_FORMAT(outsourcing.contract_date,'%Y-%m-%d') &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d')</if>
            <if test="endTime != null and endTime != ''">  and  DATE_FORMAT(outsourcing.contract_date,'%Y-%m-%d') &lt;=   DATE_FORMAT(#{endTime},'%Y-%m-%d')</if>
            <if test="supplierName != null and supplierName != ''"> and supplier.`name` LIKE #{supplierName} </if>
            <if test="supplierId != null and supplierId != ''"> and supplier.`id` = #{supplierId} </if>
            <if test="materielType != null and materielType != ''"> and materiel.`type` = #{materielType} </if>
            <if test="userId != null and userId != ''"> and outsourcing.outsourcing_person = #{userId} </if>
            <if test="auditSign != null and auditSign != ''"> and outsourcing.audit_sign = #{auditSign} </if>
            <if test="deptId != null and deptId != ''"> and outsourcing.outsourcing_person_dept = #{deptId} </if>
        </where>
        <choose>
            <when test="sort != null and sort.trim() != ''">
                order by ${sort} ${order}
            </when>
            <otherwise>
                order by outsourcing.`id` desc,item.`id`
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="debtDueList" resultType="java.util.Map">
        SELECT
        pay.`id`,
        outsourcing.`id` AS outsourcingContractId,
        supplier.`id` AS supplierId,
        supplier.`name` AS supplierName,
        outsourcingUser.`name` AS userName,
        outsourcingUserDept.name AS deptName,
        outsourcing.`contract_code` AS `contractCode`,
        outsourcing.contract_date AS contractDate,
        pay.remarks AS remarks,
        pay.payable_date AS payableDate,
        pay.payable_amount AS payableAmount,
        pay.paid_amount AS paidAmount,
        pay.unpaid_amount AS unpaidAmount,
        DATEDIFF(DATE_FORMAT(pay.payable_date,'%Y-%m-%d'),DATE_FORMAT(#{endTime},'%Y-%m-%d')) AS expiryDays
        FROM scm_outsourcing_contract_pay pay
        LEFT JOIN scm_outsourcing_contract outsourcing ON outsourcing.id = pay.contract_id
        LEFT JOIN cus_supplier supplier ON supplier.id = outsourcing.supplier_id
        LEFT JOIN sys_user outsourcingUser ON outsourcingUser.user_id = outsourcing.purchase_person
        LEFT JOIN sys_dept outsourcingUserDept ON outsourcingUserDept.dept_id = outsourcingUser.dept_id
        <where>
            <if test="id != null and id != ''"> and pay.id = #{id} </if>
            <if test="endTime != null and endTime != ''">  and  DATE_FORMAT(pay.payable_date,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')</if>
            <if test="supplierName != null and supplierName != ''"> and supplier.`name` LIKE #{supplierName} </if>
            <if test="supplierId != null and supplierId != ''"> and supplier.`id` = #{supplierId} </if>
            <if test="userId != null and userId != ''"> and outsourcingUser.user_id = #{userId} </if>
            <if test="deptId != null and deptId != ''"> and outsourcingUser.dept_id = #{deptId} </if>
            <if test="auditSign != null and auditSign != ''"> and outsourcing.audit_sign = #{auditSign} </if>
             AND pay.unpaid_amount &gt; 0
        </where>
        ORDER BY pay.payable_date
    </select>

    <select id="summaryList" resultType="java.util.Map">
        SELECT
        item.`id`,
        outsourcing.`id` AS outsourcingContractId,
        outsourcing.`contract_code` AS `contractCode`,
        outsourcing.contract_date AS contractDate,
        IFNULL(supplier.`id`,'') AS `supplierId`,
        supplier.`name` AS supplierName,
        IFNULL(outsourcingUser.`user_id`,'') AS `userId`,
        outsourcingUser.`name` AS userName,
        IFNULL(outsourcingUserDept.dept_id,'') AS `deptId`,
        outsourcingUserDept.name AS deptName,
        materiel.serial_no AS materielSerialNo,
        materiel.name AS materielName,
        materiel.specification AS specification,
        unitUom.name AS unitUomName,
        SUM(item.`count`) AS `count`,
        SUM(item.`tax_amount`) AS taxAmount
        FROM
        scm_outsourcingcontract_item item
        LEFT JOIN scm_outsourcingcontract outsourcing ON outsourcing.id = item.outsourcingcontract_id
        LEFT JOIN cus_supplier supplier ON supplier.id = outsourcing.supplier_id
        LEFT JOIN sys_user outsourcingUser ON outsourcingUser.user_id = outsourcing.outsourcing_person
        LEFT JOIN sys_dept outsourcingUserDept ON outsourcingUserDept.dept_id = outsourcing.outsourcing_person_dept
        LEFT JOIN cus_materiel materiel ON materiel.`id`=item.`materiel_id`
        LEFT JOIN cus_dictionary unitUom ON unitUom.id = materiel.`unit_uom`
        <where>
            <if test="id != null and id != ''"> and item.id = #{id} </if>
            <if test="supplierId != null and supplierId != ''"> and supplier.`id` = #{supplierId} </if>
            <if test="supplierName != null and supplierName != ''"> and supplier.`name` LIKE #{supplierName} </if>
            <if test="deptId != null and deptId != ''"> and outsourcing.outsourcing_person_dept = #{deptId} </if>
            <if test="userId != null and userId != ''"> and outsourcing.outsourcing_person = #{userId} </if>
            <if test="startTime != null and startTime != ''"> and  DATE_FORMAT(outsourcing.contract_date,'%Y-%m-%d') &gt;=  DATE_FORMAT(#{startTime},'%Y-%m-%d')</if>
            <if test="endTime != null and endTime != ''">  and  DATE_FORMAT(outsourcing.contract_date,'%Y-%m-%d') &lt;=   DATE_FORMAT(#{endTime},'%Y-%m-%d')</if>
            <if test="auditSign != null and auditSign != ''"> and outsourcing.audit_sign = #{auditSign} </if>
        </where>
        GROUP BY item.`materiel_id`
        ORDER BY outsourcing.`id` DESC
    </select>

    <select id="balanceList" resultType="java.util.Map">
        SELECT
        pay.`id`,
        outsourcing.`id` AS outsourcingContractId,
        supplier.`id` AS supplierId,
        supplier.`name` AS supplierName,
        outsourcingUser.`name` AS userName,
        outsourcingUserDept.name AS deptName,
        outsourcing.`contract_code` AS `contractCode`,
        outsourcing.contract_date AS contractDate,
        SUM(pay.payable_amount) AS payableAmount,
        SUM(pay.paid_amount) AS paidAmount,
        SUM(pay.unpaid_amount) AS unpaidAmount
        FROM scm_outsourcing_contract_pay pay
        LEFT JOIN scm_outsourcing_contract outsourcing ON outsourcing.id = pay.contract_id
        LEFT JOIN cus_supplier supplier ON supplier.id = outsourcing.supplier_id
        LEFT JOIN sys_user outsourcingUser ON outsourcingUser.user_id = outsourcing.purchase_person
        LEFT JOIN sys_dept outsourcingUserDept ON outsourcingUserDept.dept_id = outsourcingUser.dept_id
        <where>
            <if test="id != null and id != ''"> and pay.id = #{id} </if>
            <if test="endTime != null and endTime != ''">  and  DATE_FORMAT(outsourcing.contract_date,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')</if>
            <if test="supplierName != null and supplierName != ''"> and supplier.`name` LIKE #{supplierName} </if>
            <if test="supplierId != null and supplierId != ''"> and supplier.`id` = #{supplierId} </if>
            <if test="userId != null and userId != ''"> and outsourcingUser.user_id = #{userId} </if>
            <if test="deptId != null and deptId != ''"> and outsourcingUser.dept_id = #{deptId} </if>
            <if test="auditSign != null and auditSign != ''"> and outsourcing.audit_sign = #{auditSign} </if>
        </where>
        GROUP BY pay.contract_id
        ORDER BY outsourcing.contract_date,unpaidAmount DESC

    </select>

</mapper>
